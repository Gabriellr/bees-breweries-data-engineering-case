from mage_ai.data_preparation.decorators import data_loader
from pyspark.sql import SparkSession
import logging

@data_loader
def load_virtualized_parquet(*args, **kwargs):
    """
    Cria uma view temporÃ¡ria no Spark com base em arquivos Parquet no S3.
    Permite que os dados sejam consultados via Spark SQL como uma tabela virtual.
    """

    # ConfiguraÃ§Ãµes
    bucket_name = 'db-inbev-silver-layer'
    prefix = kwargs.get('folder_name', '')  # Ex: '2025-06-29/' ou subdiretÃ³rios
    s3_path = f"s3a://{bucket_name}/{prefix}*"

    logging.info(f"ðŸ“¥ Virtualizando arquivos Parquet: {s3_path}")

    # Inicializa SparkSession
    spark = SparkSession.builder.appName("VirtualizeParquet").getOrCreate()

    # LÃª arquivos Parquet e cria view temporÃ¡ria
    df = spark.read.parquet(s3_path)
    df.createOrReplaceTempView("breweries_virtual_view")

    logging.info("âœ… View temporÃ¡ria criada com nome: breweries_virtual_view")

    return df